<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Rebel Stream - Relay Viewer</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body { background: #000; color: #fff; height: 100vh; margin: 0; overflow: hidden; font-family: system-ui, sans-serif; }
      .viewer-shell { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
      
      .video-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: flex; align-items: center; justify-content: center; background: #000; }
      video { width: 100%; height: 100%; object-fit: contain; }

      /* Relay Status Overlay */
      .relay-status {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(74, 243, 163, 0.3);
        border-radius: 12px;
        padding: 15px;
        z-index: 200;
        min-width: 200px;
        font-size: 0.85rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      .relay-status.hidden { display: none; }

      .relay-status h3 {
        margin: 0 0 10px 0;
        font-size: 0.9rem;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .relay-status-item {
        display: flex;
        justify-content: space-between;
        margin: 6px 0;
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .relay-status-item:last-child {
        border-bottom: none;
      }

      .relay-status-label {
        color: var(--muted);
        font-size: 0.75rem;
      }

      .relay-status-value {
        font-weight: 600;
        color: #fff;
      }

      .relay-tier {
        display: inline-block;
        background: var(--accent);
        color: #000;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
      }

      .relay-children {
        display: inline-block;
        background: rgba(74, 243, 163, 0.2);
        color: var(--accent);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
      }

      .relay-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
      }

      .relay-indicator.active {
        background: var(--accent);
        box-shadow: 0 0 8px var(--accent);
      }

      .relay-indicator.inactive {
        background: var(--danger);
      }

      .chat-overlay {
        position: absolute;
        bottom: 80px;
        left: 20px;
        width: 320px;
        height: 320px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        z-index: 100;
        transition: 0.3s;
      }

      .chat-overlay.hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
      
      .chat-header {
        padding: 10px;
        font-weight: bold;
        font-size: 0.8rem;
        background: rgba(0,0,0,0.3);
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
      }

      #chatLog {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        font-size: 0.9rem;
        text-shadow: 1px 1px 2px #000;
        scrollbar-width: thin;
      }

      .chat-line {
        margin-bottom: 5px;
        word-wrap: break-word;
      }

      .chat-line strong {
        color: #4af3a3;
      }
      
      .chat-input-area {
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        background: rgba(0,0,0,0.3);
        border-radius: 0 0 12px 12px;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      
      .emoji-bar {
        display: flex;
        gap: 10px;
        font-size: 1.3rem;
        cursor: pointer;
        user-select: none;
        margin-bottom: 2px;
        padding: 0 4px;
        overflow-x: auto;
      }
      
      .input-row {
        display: flex;
        gap: 5px;
      }

      .chat-input {
        flex: 1;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff;
        padding: 8px;
        border-radius: 6px;
        outline: none;
      }

      .btn-send {
        background: #4af3a3;
        color: #000;
        border: none;
        padding: 0 15px;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
      }

      .controls-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding: 0 20px;
        gap: 10px;
        z-index: 101;
      }

      .btn-ctrl {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: 0.2s;
      }

      .btn-ctrl:hover {
        background: rgba(255,255,255,0.2);
      }

      .btn-ctrl.pulse-primary {
        background: var(--accent);
        color: #000;
        animation: pulse-glow 1.5s infinite;
      }

      @keyframes pulse-glow {
        0% { box-shadow: 0 0 0 0 rgba(74, 243, 163, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(74, 243, 163, 0); }
        100% { box-shadow: 0 0 0 0 rgba(74, 243, 163, 0); }
      }

      .status-pill {
        margin-right: auto;
        background: var(--danger);
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.8rem;
      }
      
      .status-pill.live {
        background: var(--accent);
        color: #000;
      }

      .viewer-join {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.75);
        z-index: 150;
      }

      .viewer-join.hidden {
        display: none;
      }

      .join-card {
        width: min(360px, 90vw);
        background: rgba(12,16,28,0.95);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 14px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      }

      .join-card h3 {
        margin: 0 0 4px;
        font-size: 1rem;
      }

      .join-card label {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .join-card input {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.08);
        color: #fff;
      }

      .join-card button {
        background: var(--accent);
        color: #000;
        border: none;
        padding: 10px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }

      #joinStatus {
        font-size: 0.75rem;
        color: var(--muted);
        min-height: 16px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="viewer-shell">
      <div class="video-layer">
        <video id="viewerVideo" autoplay playsinline muted></video>
      </div>

      <!-- Relay Status Display -->
      <div id="relayStatus" class="relay-status hidden">
        <h3>
          üåê Relay Status
          <span class="relay-indicator inactive" id="relayIndicator"></span>
        </h3>
        <div class="relay-status-item">
          <span class="relay-status-label">Tier:</span>
          <span class="relay-status-value" id="tierDisplay">-</span>
        </div>
        <div class="relay-status-item">
          <span class="relay-status-label">Capacity:</span>
          <span class="relay-status-value" id="capacityDisplay">0</span>
        </div>
        <div class="relay-status-item">
          <span class="relay-status-label">Relaying To:</span>
          <span class="relay-status-value" id="childrenDisplay">0</span>
        </div>
        <div class="relay-status-item">
          <span class="relay-status-label">Parent:</span>
          <span class="relay-status-value" id="parentDisplay" style="font-size: 0.7rem;">-</span>
        </div>
      </div>

      <!-- Join Panel -->
      <div id="viewerJoinPanel" class="viewer-join">
        <div class="join-card">
          <h3>Enter Stream</h3>
          <label for="viewerNameInput">Display Name</label>
          <input id="viewerNameInput" type="text" placeholder="Your name" />
          <button id="joinRoomBtn">Join Stream</button>
          <div id="joinStatus"></div>
        </div>
      </div>
      
      <!-- Chat -->
      <div id="chatBox" class="chat-overlay">
        <div class="chat-header">
          <span>STREAM CHAT</span>
        </div>
        <div id="chatLog"></div>
        <div class="chat-input-area">
          <div id="emojiStrip" class="emoji-bar">
            <span class="emoji">üòÄ</span>
            <span class="emoji">üòÇ</span>
            <span class="emoji">üòç</span>
            <span class="emoji">üî•</span>
            <span class="emoji">üíÄ</span>
            <span class="emoji">ü§ò</span>
            <span class="emoji">‚ù§Ô∏è</span>
          </div>
          <div class="input-row">
            <input id="chatInput" class="chat-input" placeholder="Say something..." />
            <button id="sendBtn" class="btn-send">Send</button>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls-bar">
        <div id="viewerStatus" class="status-pill">OFFLINE</div>
        <button id="toggleRelayBtn" class="btn-ctrl">üìä Relay Info</button>
        <button id="toggleChatBtn" class="btn-ctrl">üí¨ Toggle Chat</button>
        <button id="unmuteBtn" class="btn-ctrl pulse-primary">üîá Unmute</button>
        <button id="fullscreenBtn" class="btn-ctrl">‚õ∂ Fullscreen</button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="config/ice.js"></script>
    <script src="relay-viewer.js"></script>
    <script src="chat-helper.js"></script>
    <script>
      // Parse room from URL
      const params = new URLSearchParams(window.location.search);
      const roomName = params.get('room');

      if (!roomName) {
        document.getElementById('joinStatus').textContent = 'No room specified in URL';
      }

      const socket = io();
      let relayViewer = null;
      let viewerName = '';

      // Join button handler
      document.getElementById('joinRoomBtn').onclick = () => {
        viewerName = document.getElementById('viewerNameInput').value.trim();
        
        if (!viewerName) {
          document.getElementById('joinStatus').textContent = 'Please enter your name';
          return;
        }

        if (!roomName) {
          document.getElementById('joinStatus').textContent = 'Invalid room';
          return;
        }

        document.getElementById('joinStatus').textContent = 'Connecting...';

        // Create relay viewer
        relayViewer = new RelayViewer(socket, getRtcConfig);
        relayViewer.joinRoom(roomName, viewerName);

        // Subscribe to relay status updates
        relayViewer.onStatusUpdate = updateRelayUI;

        // Hide join panel
        setTimeout(() => {
          document.getElementById('viewerJoinPanel').classList.add('hidden');
          document.getElementById('viewerStatus').textContent = 'LIVE';
          document.getElementById('viewerStatus').classList.add('live');
        }, 1000);
      };

      // Update relay UI
      function updateRelayUI(status) {
        document.getElementById('tierDisplay').innerHTML = 
          `<span class="relay-tier">Tier ${status.tier || '?'}</span>`;
        document.getElementById('capacityDisplay').textContent = status.capacity || 0;
        document.getElementById('childrenDisplay').innerHTML = 
          `<span class="relay-children">${status.childCount || 0}/${status.capacity || 0}</span>`;
        document.getElementById('parentDisplay').textContent = 
          status.parentId ? status.parentId.substring(0, 8) : '-';

        const indicator = document.getElementById('relayIndicator');
        if (status.parentConnected) {
          indicator.classList.remove('inactive');
          indicator.classList.add('active');
        } else {
          indicator.classList.remove('active');
          indicator.classList.add('inactive');
        }
      }

      // Toggle relay status
      document.getElementById('toggleRelayBtn').onclick = () => {
        document.getElementById('relayStatus').classList.toggle('hidden');
      };

      // Chat functionality
      const chatLog = document.getElementById('chatLog');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');

      function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg || !viewerName || !roomName) return;

        socket.emit('public-chat', {
          room: roomName,
          name: viewerName,
          text: msg,
          ts: Date.now()
        });

        chatInput.value = '';
      }

      sendBtn.onclick = sendMessage;
      chatInput.onkeypress = (e) => {
        if (e.key === 'Enter') sendMessage();
      };

      socket.on('public-chat', (data) => {
        if (window.chatHelper) {
          chatHelper.appendMessage(chatLog, data.name, data.text, data.ts);
        } else {
          // Fallback
          const line = document.createElement('div');
          line.className = 'chat-line';
          line.innerHTML = `<strong>${data.name}:</strong> ${data.text}`;
          chatLog.appendChild(line);
          chatLog.scrollTop = chatLog.scrollHeight;
        }
      });

      // Emoji clicks
      document.querySelectorAll('.emoji').forEach(emoji => {
        emoji.onclick = () => {
          chatInput.value += emoji.textContent;
          chatInput.focus();
        };
      });

      // Toggle chat
      document.getElementById('toggleChatBtn').onclick = () => {
        document.getElementById('chatBox').classList.toggle('hidden');
      };

      // Unmute
      document.getElementById('unmuteBtn').onclick = () => {
        const video = document.getElementById('viewerVideo');
        video.muted = false;
        document.getElementById('unmuteBtn').remove();
      };

      // Fullscreen
      document.getElementById('fullscreenBtn').onclick = () => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          document.documentElement.requestFullscreen();
        }
      };
    </script>
  </body>
</html>
